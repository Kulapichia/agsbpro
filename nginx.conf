# --- Nginx å…¨å±€é…ç½® ---
user nginx; # æ ‡å‡†ç”¨æˆ·ï¼Œå¦‚æœæ‚¨çš„ç³»ç»Ÿæ˜¯Ubuntu/RHELï¼Œè¯·æ”¹ä¸º user www-data;
pid /run/nginx.pid;
worker_processes auto;

# å®šä¹‰é”™è¯¯æ—¥å¿—è·¯å¾„
error_log /var/log/nginx/error.log warn;

events {
    worker_connections 1024;
}

http {
    # åŸºç¡€HTTPè®¾ç½®
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    sendfile      on;
    tcp_nopush    on;
    keepalive_timeout 65;

    # å®šä¹‰è®¿é—®æ—¥å¿—æ ¼å¼å’Œè·¯å¾„
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
    access_log  /var/log/nginx/access.log  main;

    # WebSocket è¿æ¥å‡çº§æ”¯æŒ (å¯¹VMess+WSç­‰ä»£ç†è‡³å…³é‡è¦)
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # ==================== æ™ºèƒ½è¯ä¹¦é€‰æ‹© ====================
    # æ ¹æ®è®¿é—®çš„åŸŸå($host)åŠ¨æ€è®¾ç½®è¯ä¹¦å’Œå¯†é’¥å˜é‡
    # è¿™æ ·å¯ä»¥åœ¨ä¸€ä¸ª server å—ä¸­å¤„ç†å¤šä¸ªä½¿ç”¨ä¸åŒè¯ä¹¦çš„åŸŸå
    map $host $ssl_certificate_file {
        # Hysteria2 çš„åŸŸåä½¿ç”¨ /root/.hysteria2/ çš„è¯ä¹¦
        hy2.xxxxx.com       /root/.hysteria2/cert/server.crt;
        vpn.xxxxx.com       /root/.hysteria2/cert/server.crt;

        # ArgoSB çš„åŸŸåä½¿ç”¨ /opt/ çš„è¯ä¹¦
        argosb.xxxxx.com    /opt/YYYYY.pem;

        # é»˜è®¤è¯ä¹¦ï¼Œç”¨äºIPç›´è¿æˆ–å…¶ä»–æœªåŒ¹é…çš„åŸŸå
        default             /root/.hysteria2/cert/server.crt;
    }

    map $host $ssl_certificate_key_file {
        hy2.xxxxx.com       /root/.hysteria2/cert/server.key;
        vpn.xxxxx.com       /root/.hysteria2/cert/server.key;
        argosb.xxxxx.com    /opt/YYYYY.key;
        default             /root/.hysteria2/cert/server.key;
    }
    # ================================================================

    # =====================================================================================
    # ğŸš€ æ™ºèƒ½ååŒé…ç½® (æ ¸å¿ƒä¿®æ”¹)
    # å°†æ­¤æ–‡ä»¶æ”¾åœ¨ http å—çš„å¼€å§‹éƒ¨åˆ†ï¼Œç¡®ä¿å®ƒè¢«ä¼˜å…ˆåŠ è½½
    # è„šæœ¬ agsb.py ä¼šè‡ªåŠ¨ç”Ÿæˆè¿™ä¸ªæ–‡ä»¶
    # =====================================================================================
    # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼ŒNginxä¼šå¿½ç•¥å®ƒè€Œä¸ä¼šæŠ¥é”™
    # include /home/YOUR_USERNAME/.agsb/nginx_agsb_snippet.conf; 
    # !!é‡è¦!!: è¯·å–æ¶ˆæ³¨é‡Šå°† YOUR_USERNAME æ›¿æ¢ä¸ºå®é™…æ‰§è¡Œ agsb.py è„šæœ¬çš„ç”¨æˆ·å
    # ä¾‹å¦‚ï¼š/home/ubuntu/.agsb/nginx_agsb_snippet.conf
    # å¦‚æœæ‚¨æ˜¯ç”¨ root ç”¨æˆ·æ‰§è¡Œçš„ï¼Œè·¯å¾„å°±æ˜¯ /root/.agsb/nginx_agsb_snippet.conf
    

    # -------------------------------------------------------------------------------------
    # ğŸ›¡ï¸ ç»Ÿä¸€çš„ 443 ç«¯å£æœåŠ¡é…ç½® (åˆå¹¶ server å—)
    # -------------------------------------------------------------------------------------
    # --- 1. vpn.xxxxx.com çš„æ–‡ä»¶ä¸‹è½½æœåŠ¡ ---
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name vpn.xxxxx.com; # ç²¾ç¡®åŒ¹é…åŸŸå


        # åŠ¨æ€åŠ è½½è¯ä¹¦
        ssl_certificate         $ssl_certificate_file;
        ssl_certificate_key     $ssl_certificate_key_file;
        ssl_protocols           TLSv1.2 TLSv1.3;

        # --- ç»Ÿä¸€çš„ location å—ï¼Œå¤„ç†æ‰€æœ‰è¯·æ±‚ ---
        location / {

            # å¯¹ç‰¹å®šæ–‡ä»¶ç±»å‹æ·»åŠ ä¸‹è½½å¤´
            if ($request_uri ~* \.(yaml|txt|json)$) {
                add_header Content-Disposition 'attachment';
            }
            # ä»£ç†åˆ° Hysteria2 çš„æ–‡ä»¶æœåŠ¡ç«¯å£
            proxy_pass http://127.0.0.1:8085;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            proxy_cache off;
        }
    }


    # --- 2. argosb.xxxxx.com çš„ä¼ªè£…ç½‘ç«™ ---
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name argosb.xxxxx.com; # ç²¾ç¡®åŒ¹é…åŸŸå

        ssl_certificate         $ssl_certificate_file;
        ssl_certificate_key     $ssl_certificate_key_file;
        ssl_protocols           TLSv1.2 TLSv1.3;

        # ArgoSBçš„WebSocketè·¯å¾„ç”±å…¶ä»–è„šæœ¬ç”Ÿæˆçš„includeæ–‡ä»¶å¤„ç†ï¼Œè¿™é‡Œåªé…ç½®ä¼ªè£…ç½‘ç«™
        root /var/www/html/argosb;
        index index.html;

        location / {
            try_files $uri $uri/ =404;
        }
        # æ³¨æ„ï¼šArgoSB çš„ WebSocket è·¯å¾„åº”ç”±å¦ä¸€ä¸ªè„šæœ¬åŠ¨æ€ç”Ÿæˆé…ç½®
        # å¦‚æœéœ€è¦æ‰‹åŠ¨é…ç½®ï¼Œå¯ä»¥åƒè¿™æ ·æ·»åŠ  location å—ï¼š
        # location /your-argosb-websocket-path {
        #     proxy_pass http://127.0.0.1:your-argosb-port;
        #     proxy_http_version 1.1;
        #     proxy_set_header Upgrade $http_upgrade;
        #     proxy_set_header Connection $connection_upgrade;
        # }
    }

    # --- 3. hy2.xxxxx.com çš„ä¼ªè£…ç½‘ç«™ ---
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name hy2.xxxxx.com; # ç²¾ç¡®åŒ¹é…åŸŸå

        ssl_certificate         $ssl_certificate_file;
        ssl_certificate_key     $ssl_certificate_key_file;
        ssl_protocols           TLSv1.2 TLSv1.3;

        root /root/.hysteria2/web;
        index index.html;
        
        location / {
            try_files $uri $uri/ =404;
        }
    }

    # --- 4. é»˜è®¤æœåŠ¡ (å¤„ç†IPç›´è¿å’Œå…¶ä»–æœªåŒ¹é…çš„åŸŸå) ---
    server {
        listen 443 ssl default_server;
        listen [::]:443 ssl default_server;
        http2 on;
        server_name _; # _ ä»£è¡¨æ•è·æ‰€æœ‰æœªè¢«ä¸Šé¢ server å—åŒ¹é…çš„è¯·æ±‚

        # ä½¿ç”¨ map æŒ‡ä»¤ä¸­çš„ default è¯ä¹¦
        ssl_certificate         $ssl_certificate_file;
        ssl_certificate_key     $ssl_certificate_key_file;
        ssl_protocols           TLSv1.2 TLSv1.3;

        # IPç›´è¿æ—¶ï¼ŒåŒæ ·æŒ‡å‘ Hysteria2 çš„ä¼ªè£…ç«™
        root /root/.hysteria2/web;
        index index.html;
        
        location / {
            try_files $uri $uri/ =404;
        }


    }
    
    # -------------------------------------------------------------------------------------
    # ğŸŒ HTTP åˆ° HTTPS çš„å…¨å±€é‡å®šå‘
    # -------------------------------------------------------------------------------------
    server {
        listen 80 default_server;
        listen [::]:80 default_server;
        
        server_name _;
        
        return 301 https://$host$request_uri;
    }
}
