# --- Nginx å…¨å±€é…ç½® ---
user nginx; # æ ‡å‡†ç”¨æˆ·ï¼Œå¦‚æœæ‚¨çš„ç³»ç»Ÿæ˜¯Ubuntu/RHELï¼Œè¯·æ”¹ä¸º user www-data;
pid /run/nginx.pid;
worker_processes auto;

# å®šä¹‰é”™è¯¯æ—¥å¿—è·¯å¾„
error_log /var/log/nginx/error.log warn;

events {
    worker_connections 1024;
}

http {
    # åŸºç¡€HTTPè®¾ç½®
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    sendfile      on;
    tcp_nopush    on;
    keepalive_timeout 65;

    # å®šä¹‰è®¿é—®æ—¥å¿—æ ¼å¼å’Œè·¯å¾„
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
    access_log  /var/log/nginx/access.log  main;

    # WebSocket è¿æ¥å‡çº§æ”¯æŒ (å¯¹VMess+WSç­‰ä»£ç†è‡³å…³é‡è¦)
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # ==================== æ™ºèƒ½è¯ä¹¦é€‰æ‹© ====================
    # æ ¹æ®è®¿é—®çš„åŸŸå($host)åŠ¨æ€è®¾ç½®è¯ä¹¦å’Œå¯†é’¥å˜é‡
    # è¿™æ ·å¯ä»¥åœ¨ä¸€ä¸ª server å—ä¸­å¤„ç†å¤šä¸ªä½¿ç”¨ä¸åŒè¯ä¹¦çš„åŸŸå
    map $host $ssl_certificate_file {
        # Hysteria2 çš„åŸŸåä½¿ç”¨ /root/.hysteria2/ çš„è¯ä¹¦
        hy2.xxxxx.com       /root/.hysteria2/cert/server.crt;
        vpn.xxxxx.com       /root/.hysteria2/cert/server.crt;

        # ArgoSB çš„åŸŸåä½¿ç”¨ /opt/ çš„è¯ä¹¦
        argosb.xxxxx.com    /opt/xxxxx.pem;

        # é»˜è®¤è¯ä¹¦ï¼Œç”¨äºIPç›´è¿æˆ–å…¶ä»–æœªåŒ¹é…çš„åŸŸå
        default             /root/.hysteria2/cert/server.crt;
    }

    map $host $ssl_certificate_key_file {
        hy2.xxxxx.com       /root/.hysteria2/cert/server.key;
        vpn.xxxxx.com       /root/.hysteria2/cert/server.key;
        argosb.xxxxx.com    /opt/xxxxx.key;
        default             /root/.hysteria2/cert/server.key;
    }
    # ================================================================

    # =====================================================================================
    # ğŸš€ æ™ºèƒ½ååŒé…ç½® (æ ¸å¿ƒä¿®æ”¹)
    # å°†æ­¤æ–‡ä»¶æ”¾åœ¨ http å—çš„å¼€å§‹éƒ¨åˆ†ï¼Œç¡®ä¿å®ƒè¢«ä¼˜å…ˆåŠ è½½
    # è„šæœ¬ agsb.py ä¼šè‡ªåŠ¨ç”Ÿæˆè¿™ä¸ªæ–‡ä»¶
    # =====================================================================================
    # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼ŒNginxä¼šå¿½ç•¥å®ƒè€Œä¸ä¼šæŠ¥é”™
    # include /home/YOUR_USERNAME/.agsb/nginx_agsb_snippet.conf; 
    # !!é‡è¦!!: è¯·å°† YOUR_USERNAME æ›¿æ¢ä¸ºå®é™…æ‰§è¡Œ agsb.py è„šæœ¬çš„ç”¨æˆ·å
    # ä¾‹å¦‚ï¼š/home/ubuntu/.agsb/nginx_agsb_snippet.conf
    # å¦‚æœæ‚¨æ˜¯ç”¨ root ç”¨æˆ·æ‰§è¡Œçš„ï¼Œè·¯å¾„å°±æ˜¯ /root/.agsb/nginx_agsb_snippet.conf
    

    # -------------------------------------------------------------------------------------
    # ğŸ›¡ï¸ ç»Ÿä¸€çš„ 443 ç«¯å£æœåŠ¡é…ç½® (åˆå¹¶ server å—)
    # -------------------------------------------------------------------------------------
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;

        # åŒæ—¶å¤„ç†æ‰€æœ‰åŸŸåï¼ŒåŒ…æ‹¬IPç›´è¿
        server_name argosb.xxxxx.com hy2.xxxxx.com vpn.xxxxx.com _; 

        # ä½¿ç”¨ map æŒ‡ä»¤åŠ¨æ€åŠ è½½è¯ä¹¦
        ssl_certificate         $ssl_certificate_file;
        ssl_certificate_key     $ssl_certificate_key_file;
        ssl_protocols           TLSv1.2 TLSv1.3;

        # --- ç»Ÿä¸€çš„ location å—ï¼Œå¤„ç†æ‰€æœ‰è¯·æ±‚ ---
        location / {
            # --- 1. å¤„ç† vpn.xxxxx.com çš„æµé‡ (æ–‡ä»¶ä¸‹è½½) ---
            if ($host = "vpn.xxxxx.com") {
                # å¯¹ç‰¹å®šæ–‡ä»¶ç±»å‹æ·»åŠ ä¸‹è½½å¤´
                if ($request_uri ~* \.(yaml|txt|json)$) {
                    add_header Content-Disposition 'attachment';
                }
                proxy_pass http://127.0.0.1:8085; # æŒ‡å‘ Hysteria2 çš„æ–‡ä»¶æœåŠ¡ç«¯å£
                proxy_http_version 1.1;
                proxy_set_header Connection "";
                proxy_set_header Host $http_host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_buffering off;
                proxy_cache off;
            }

            # --- 2. å¤„ç† ArgoSB å’Œ Hysteria2 çš„ä¼ªè£…ç½‘ç«™ ---
            # å¦‚æœæ˜¯ argosb.xxxxx.comï¼Œä½¿ç”¨å®ƒçš„ä¼ªè£…ç«™
            if ($host = "argosb.xxxxx.com") {
                root /var/www/html/argosb;
                index index.html;
                try_files $uri $uri/ =404;
            }
            
            # å¦‚æœæ˜¯ hy2.xxxxx.com æˆ– IPç›´è¿ï¼Œä½¿ç”¨ Hysteria2 çš„ä¼ªè£…ç«™
            if ($host = "hy2.xxxxx.com" or $host = $server_addr) {
                root /root/.hysteria2/web;
                index index.html;
                try_files $uri $uri/ =404;
            }

            # --- 3. å¦‚æœä»¥ä¸Šéƒ½ä¸åŒ¹é…ï¼Œè¿”å›ä¸€ä¸ªé€šç”¨çš„404é¡µé¢ ---
            # è¿™æ˜¯ä¸€ä¸ªå…œåº•è§„åˆ™ï¼Œé˜²æ­¢ Nginx æŠ¥é”™
            return 404;
        }

        # æ³¨æ„ï¼šArgoSB çš„ WebSocket è·¯å¾„ç°åœ¨ç”± include çš„æ–‡ä»¶å¤„ç†
        # æ—§çš„ location /a91b59b6-vm { ... } å·²è¢«ç§»è‡³ nginx_agsb_snippet.conf
    }
    
    # -------------------------------------------------------------------------------------
    # ğŸŒ HTTP åˆ° HTTPS çš„å…¨å±€é‡å®šå‘
    # -------------------------------------------------------------------------------------
    server {
        listen 80 default_server;
        listen [::]:80 default_server;
        
        server_name _;
        
        return 301 https://$host$request_uri;
    }
}
